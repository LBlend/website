---
import { localeNames, locales, type Locale } from "@i18n/index";

import LanguageIcon from "@assets/icons/language.svg";

const currentLocale = Astro.locals.locale as Locale;
---

<style>
  .lang-icon-gradient {
    fill: url(#lang-gradient);
  }

  #lang-menu {
    opacity: 0;
    visibility: hidden;
  }

  #lang-menu.open {
    opacity: 1;
    visibility: visible;
  }
</style>

<div class="relative">
  <svg width="0" height="0" class="absolute">
    <defs>
      <linearGradient id="lang-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color: var(--gradient-pink-start)"></stop>
        <stop offset="100%" style="stop-color: var(--gradient-pink-end)"></stop>
      </linearGradient>
    </defs>
  </svg>
  <button id="lang-button" class="cursor-pointer rounded p-2 hover:bg-gray-700" aria-label="Select language">
    <LanguageIcon id="lang-icon" class="size-5" />
  </button>

  <div
    id="lang-menu"
    class="bg-backgroundlight absolute right-0 z-50 mt-1 min-w-32 rounded-lg border border-gray-700/30 shadow-lg transition-all duration-200"
  >
    {
      locales.map((locale) => (
        <button
          class={`flex w-full cursor-pointer items-center justify-between px-4 py-3 text-left hover:bg-gray-700/20 ${
            locale === currentLocale ? "bg-gray-700/10 font-bold" : ""
          }`}
          data-locale={locale}
        >
          {localeNames[locale]}
          {locale === currentLocale && (
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          )}
        </button>
      ))
    }
  </div>
</div>

<script>
  function initLanguageSwitcher() {
    const button = document.getElementById("lang-button");
    const menu = document.getElementById("lang-menu");
    const icon = document.getElementById("lang-icon");

    if (!button || !menu || !icon) return;

    const updateIconGradient = () => {
      const isOpen = menu.classList.contains("open");
      if (isOpen) {
        icon.classList.add("lang-icon-gradient");
      } else {
        icon.classList.remove("lang-icon-gradient");
      }
    };

    // Toggle menu
    button.addEventListener("click", (e) => {
      e.stopPropagation();

      // Close nav dropdown if open
      document.querySelectorAll(".dropdown.open").forEach((dropdown) => {
        dropdown.classList.remove("open");
        dropdown.querySelector(".dropdown-button")?.setAttribute("aria-expanded", "false");
      });

      menu.classList.toggle("open");
      updateIconGradient();
    });

    // Close menu when clicking outside
    document.addEventListener("click", () => {
      menu.classList.remove("open");
      updateIconGradient();
    });

    // Handle language selection
    menu.querySelectorAll("button[data-locale]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const locale = (e.currentTarget as HTMLButtonElement).dataset.locale;
        if (locale) {
          // Set cookie with 1 year expiry
          const expires = new Date();
          expires.setFullYear(expires.getFullYear() + 1);
          document.cookie = `lang=${locale};path=/;expires=${expires.toUTCString()};SameSite=Lax`;
          // Reload page to apply new language
          window.location.reload();
        }
      });
    });
  }

  // Initialize on page load
  initLanguageSwitcher();

  // Re-initialize after Astro page transitions
  document.addEventListener("astro:after-swap", initLanguageSwitcher);
</script>
