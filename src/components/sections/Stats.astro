---
import { useTranslations } from "@i18n/index";

const locale = Astro.locals.locale;
const t = useTranslations(locale);

const disclaimerLines = t("stats.disclaimer").split("\n");
---

<section class="flex flex-col items-center justify-center gap-8" data-locale={locale}>
  <h2 class="text-center text-4xl font-bold">{t("stats.title")}</h2>
  <div class="flex flex-col place-self-center">
    <blockquote>
      <p>{t("stats.quote")}</p>
    </blockquote>
    <p class="pl-2 font-light">{t("stats.quoteAttribution")}</p>
  </div>
  <div id="stats-container" class="flex flex-col items-center justify-center gap-2">
    <!-- Skeleton loading state -->
    <div class="flex flex-wrap items-center justify-center gap-12">
      <article class="flex flex-col items-center justify-center gap-1">
        <span class="skeleton-stat h-8 w-16 animate-pulse rounded bg-gray-700"></span>
        <p class="text-center text-lg font-light">{t("stats.moviesWatched")}</p>
      </article>
      <article class="flex flex-col items-center justify-center gap-1">
        <span class="skeleton-stat h-8 w-16 animate-pulse rounded bg-gray-700"></span>
        <p class="text-center text-lg font-light">{t("stats.showsWatched")}</p>
      </article>
      <article class="flex flex-col items-center justify-center gap-1">
        <span class="skeleton-stat h-8 w-24 animate-pulse rounded bg-gray-700"></span>
        <p class="text-center text-lg font-light">{t("stats.watchingAnime")}</p>
      </article>
    </div>
    <div class="mt-8 flex flex-wrap items-center justify-center gap-12">
      <article class="flex flex-col items-center justify-center gap-1">
        <span class="skeleton-stat h-8 w-24 animate-pulse rounded bg-gray-700"></span>
        <p class="text-center text-lg font-light">{t("stats.playingGames")}</p>
      </article>
      <article class="flex flex-col items-center justify-center gap-1">
        <span class="skeleton-stat h-8 w-24 animate-pulse rounded bg-gray-700"></span>
        <p class="text-center text-lg font-light">{t("stats.clickingCircles")}</p>
      </article>
      <article class="flex flex-col items-center justify-center gap-1">
        <span class="skeleton-stat h-8 w-24 animate-pulse rounded bg-gray-700"></span>
        <p class="text-center text-lg font-light">{t("stats.programming")}</p>
      </article>
    </div>
  </div>
  <div class="text-center font-light italic">
    <p>
      {
        disclaimerLines.map((line, i) => (
          <>
            {line}
            {i < disclaimerLines.length - 1 && <br />}
          </>
        ))
      }
    </p>
  </div>
</section>

<script
  is:inline
  type="module"
  src="https://cdn.jsdelivr.net/gh/lekoala/formidable-elements@master/dist/count-up.min.js"></script>

<script>
  interface StatsData {
    osu: { playTime: number };
    wakatime: { programmingHours: number };
    anilist: { animeDaysWatched: number };
    steam: { gamingHours: number };
    simkl: {
      movies: { hoursWatched: number; completedCount: number };
      shows: { hoursWatched: number; completedCount: number };
    };
  }

  interface StatsTranslations {
    moviesWatched: string;
    showsWatched: string;
    watchingAnime: string;
    playingGames: string;
    clickingCircles: string;
    programming: string;
    days: string;
    hours: string;
  }

  function createStatHtml(value: number, text: string, suffix: string = "", decimalPlaces: number = 0): string {
    const valueHtml =
      value > 0
        ? `<count-up data-duration="3" ${suffix ? `data-suffix="${suffix}"` : ""} data-decimal-places="${decimalPlaces}" class="text-center text-2xl font-bold">${value}</count-up>`
        : `<span class="text-center text-2xl font-bold">?</span>`;

    return `<article class="flex flex-col items-center justify-center gap-1">
      ${valueHtml}
      <p class="text-center text-lg font-light">${text}</p>
    </article>`;
  }

  async function loadStats() {
    const container = document.getElementById("stats-container");
    if (!container) return;

    const section = container.closest("section");
    const locale = section?.getAttribute("data-locale") || "en";

    try {
      const response = await fetch("/api/stats/all");
      if (!response.ok) throw new Error("Failed to fetch stats");

      const data: StatsData = await response.json();

      const translations: Record<string, StatsTranslations> = {
        en: {
          moviesWatched: "Movies Watched",
          showsWatched: "Shows Watched",
          watchingAnime: "Watching weeb trash",
          playingGames: "Playing games on Steam",
          clickingCircles: "Clicking circles in osu!",
          programming: "Programming",
          days: " days",
          hours: " hours",
        },
        no: {
          moviesWatched: "Filmer sett",
          showsWatched: "Serier sett",
          watchingAnime: "Med weeb-faenskap",
          playingGames: "Spilt på Steam",
          clickingCircles: "Brukt på osu!",
          programming: "Programmering",
          days: " dager",
          hours: " timer",
        },
        ko: {
          moviesWatched: "본 영화",
          showsWatched: "본 시리즈",
          watchingAnime: "오타쿠 쓰레기 시청",
          playingGames: "Steam에서 게임 플레이",
          clickingCircles: "osu!에서 원 클릭",
          programming: "프로그래밍",
          days: "일",
          hours: "시간",
        },
      };

      const t = translations[locale] || translations.en;

      container.innerHTML = `
        <div class="flex flex-wrap items-center justify-center gap-12">
          ${createStatHtml(data.simkl.movies.completedCount, t.moviesWatched, "", 0)}
          ${createStatHtml(data.simkl.shows.completedCount, t.showsWatched, "", 0)}
          ${createStatHtml(data.anilist.animeDaysWatched, t.watchingAnime, t.days, 1)}
        </div>
        <div class="mt-8 flex flex-wrap items-center justify-center gap-12">
          ${createStatHtml(data.steam.gamingHours, t.playingGames, t.hours, 0)}
          ${createStatHtml(data.osu.playTime, t.clickingCircles, t.hours, 0)}
          ${createStatHtml(data.wakatime.programmingHours, t.programming, t.hours, 0)}
        </div>
      `;
    } catch (error) {
      console.error("Failed to load stats:", error);
    }
  }

  loadStats();
  document.addEventListener("astro:after-swap", loadStats);
</script>
